name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Security scanning jobs
  security-scan-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install bandit safety

    - name: Run Bandit security linter
      run: bandit -r backend/app -f json -o bandit-report.json || true
      continue-on-error: true

    - name: Run Safety check
      run: safety check --json --output safety-report.json || true
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-backend
        path: |
          bandit-report.json
          safety-report.json

  security-scan-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --json > npm-audit.json || true
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-frontend
        path: frontend/npm-audit.json

  # Container image scanning
  image-scan:
    runs-on: ubuntu-latest
    needs: [security-scan-backend, security-scan-frontend]
    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: backend/Dockerfile
        push: false
        load: true
        tags: bahnvision-backend:test

    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: frontend/Dockerfile
        push: false
        load: true
        tags: bahnvision-frontend:test

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@v0.0.10
      with:
        image-ref: |
          bahnvision-backend:test
          bahnvision-frontend:test
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Static Application Security Testing (SAST)
  sast-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/secrets
        output: semgrep-report.json
        generate_sarif: true

    - name: Upload Semgrep results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: semgrep-report.sarif

  # Backend testing
  test-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install pytest pytest-asyncio pytest-cov httpx

    - name: Run tests with coverage
      run: |
        cd backend
        pytest --cov=app --cov-report=xml --cov-report=html

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: backend/coverage.xml
        flags: backend
        name: backend-coverage

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: backend/htmlcov/

  # Frontend testing
  test-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Run unit tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false

    - name: Upload coverage reports
      uses: codecov/codecov-action@v5
      with:
        file: frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  # E2E testing
  test-e2e:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Start services
      run: |
        docker compose -f docker-compose.yml -f docker-compose.demo.yml up -d
        sleep 30  # Wait for services to be healthy

    - name: Set up Node.js for E2E tests
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install Playwright
      run: |
        npm install -g @playwright/test
        npx playwright install --with-deps

    - name: Run E2E tests
      run: |
        npx playwright test --project=chromium
      continue-on-error: true

    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          playwright-report/
          test-results/

    - name: Cleanup
      if: always()
      run: |
        docker compose down --volumes --remove-orphans

  # Build and push images
  build-and-push:
    runs-on: ubuntu-latest
    needs: [security-scan-backend, security-scan-frontend, test-backend, test-frontend, image-scan, sast-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract backend metadata
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Extract frontend metadata
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Kubernetes integration test
  k8s-integration-test:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v5

    - name: Set up kind cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: bahnvision-test
        config: k8s/kind-config.yaml

    - name: Update image references in manifests
      run: |
        sed -i "s|bahnvision-backend:latest|${{ needs.build-and-push.outputs.backend-image }}|g" k8s/backend-deployment.yaml
        sed -i "s|bahnvision-frontend:latest|${{ needs.build-and-push.outputs.frontend-image }}|g" k8s/frontend-deployment.yaml

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/postgres-statefulset.yaml
        kubectl apply -f k8s/valkey-statefulset.yaml
        kubectl apply -f k8s/backend-deployment.yaml
        kubectl apply -f k8s/frontend-deployment.yaml

    - name: Wait for pods to be ready
      run: |
        kubectl wait --for=condition=available --timeout=300s deployment/bahnvision-backend
        kubectl wait --for=condition=available --timeout=300s deployment/bahnvision-frontend
        kubectl wait --for=condition=ready --timeout=300s pod/bahnvision-postgres-0
        kubectl wait --for=condition=ready --timeout=300s pod/bahnvision-valkey-0

    - name: Run health checks
      run: |
        kubectl port-forward svc/bahnvision-backend 8000:8000 &
        kubectl port-forward svc/bahnvision-frontend 3000:80 &
        sleep 10

        # Check backend health
        curl -f http://localhost:8000/health || exit 1

        # Check metrics endpoint
        curl -f http://localhost:8000/metrics || exit 1

        # Check frontend health
        curl -f http://localhost:3000/health || exit 1

    - name: Upload cluster logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: k8s-logs
        path: |
          /tmp/kind-logs/