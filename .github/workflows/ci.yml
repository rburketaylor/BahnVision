name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Security scanning jobs
  security-scan-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install bandit safety

    - name: Run Bandit security linter
      run: bandit -r backend/app -f json -o bandit-report.json || true
      continue-on-error: true

    - name: Run Safety check
      run: safety check --json --output safety-report.json || true
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-backend
        path: |
          bandit-report.json
          safety-report.json

  lint-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: pip install -r backend/requirements.txt

    - name: Run Ruff
      run: |
        cd backend
        ruff check .

    - name: Run Black
      run: |
        cd backend
        black --check .

  security-scan-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci
      env:
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --json > npm-audit.json || true
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-frontend
        path: frontend/npm-audit.json

  # Container image scanning
  image-scan:
    runs-on: ubuntu-latest
    needs: [security-scan-backend, security-scan-frontend]
    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: backend/Dockerfile
        push: false
        load: true
        tags: bahnvision-backend:test

    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: frontend/Dockerfile
        push: false
        load: true
        tags: bahnvision-frontend:test

    - name: Run Trivy vulnerability scanner on backend
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: 'bahnvision-backend:test'
        format: 'sarif'
        output: 'trivy-backend-results.sarif'

    - name: Run Trivy vulnerability scanner on frontend
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: 'bahnvision-frontend:test'
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'

    - name: Upload Trivy backend scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always() && hashFiles('trivy-backend-results.sarif') != ''
      with:
        sarif_file: 'trivy-backend-results.sarif'
        category: container-backend

    - name: Upload Trivy frontend scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always() && hashFiles('trivy-frontend-results.sarif') != ''
      with:
        sarif_file: 'trivy-frontend-results.sarif'
        category: container-frontend

  # Static Application Security Testing (SAST)
  sast-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Run Semgrep
      run: |
        # Install Semgrep
        pip install semgrep==1.142.0

        # Run Semgrep with SARIF output
        semgrep --config=auto \
          --config=p/security-audit \
          --config=p/owasp-top-ten \
          --config=p/secrets \
          --sarif \
          --output=semgrep-report.sarif \
          . || true

    - name: Upload Semgrep results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always() && hashFiles('semgrep-report.sarif') != ''
      with:
        sarif_file: 'semgrep-report.sarif'

  # Backend testing
  test-backend:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql+asyncpg://bahnvision:bahnvision@localhost:5432/bahnvision
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: bahnvision
          POSTGRES_PASSWORD: bahnvision
          POSTGRES_DB: bahnvision
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U bahnvision"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install pytest pytest-asyncio pytest-cov httpx

    - name: Run database migrations
      working-directory: backend
      env:
        DATABASE_URL: ${{ env.DATABASE_URL }}
      run: alembic upgrade head

    - name: Run tests with coverage
      run: |
        cd backend
        pytest --cov=app --cov-report=xml --cov-report=html

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: backend/coverage.xml
        flags: backend
        name: backend-coverage
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: backend/htmlcov/

  # Frontend testing
  test-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci
      env:
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    - name: Run unit tests
      run: |
        cd frontend
        npm test -- --coverage --run

    - name: Upload coverage reports
      uses: codecov/codecov-action@v5
      with:
        files: frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage
        token: ${{ secrets.CODECOV_TOKEN }}

  # E2E testing
  test-e2e:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create CI environment file
      run: cp .env.example .env

    - name: Start services
      run: |
        docker compose -f docker-compose.yml -f docker-compose.demo.yml up -d
        sleep 30  # Wait for services to be healthy

    - name: Set up Node.js for E2E tests
      uses: actions/setup-node@v6
      with:
        node-version: '24'

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci
      env:
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    - name: Install Playwright browsers
      working-directory: frontend
      run: npx playwright install --with-deps

    - name: Run E2E tests
      working-directory: frontend
      run: npm run test:e2e -- --project=chromium
      continue-on-error: true

    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          frontend/playwright-report/
          frontend/test-results/

    - name: Cleanup
      if: always()
      run: |
        docker compose down --volumes --remove-orphans

  # Build and push images
  build-and-push:
    runs-on: ubuntu-latest
    needs: [security-scan-backend, security-scan-frontend, test-backend, test-frontend, image-scan, sast-scan]
    if: github.event_name == 'workflow_dispatch'
    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract backend metadata
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Extract frontend metadata
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Kubernetes integration test
  k8s-integration-test:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v5

    - name: Set up kind cluster
      uses: helm/kind-action@v1.11.0
      with:
        cluster_name: bahnvision-test
        config: k8s/kind-config.yaml

    - name: Update image references in manifests
      run: |
        sed -i "s|bahnvision-backend:latest|${{ needs.build-and-push.outputs.backend-image }}|g" k8s/backend-deployment.yaml
        sed -i "s|bahnvision-frontend:latest|${{ needs.build-and-push.outputs.frontend-image }}|g" k8s/frontend-deployment.yaml

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/postgres-statefulset.yaml
        kubectl apply -f k8s/valkey-statefulset.yaml
        kubectl apply -f k8s/backend-deployment.yaml
        kubectl apply -f k8s/frontend-deployment.yaml

    - name: Wait for pods to be ready
      run: |
        kubectl wait --for=condition=available --timeout=300s deployment/bahnvision-backend
        kubectl wait --for=condition=available --timeout=300s deployment/bahnvision-frontend
        kubectl wait --for=condition=ready --timeout=300s pod/bahnvision-postgres-0
        kubectl wait --for=condition=ready --timeout=300s pod/bahnvision-valkey-0

    - name: Run health checks
      run: |
        kubectl port-forward svc/bahnvision-backend 8000:8000 &
        kubectl port-forward svc/bahnvision-frontend 3000:80 &
        sleep 10

        # Check backend health
        curl -f http://localhost:8000/health || exit 1

        # Check metrics endpoint
        curl -f http://localhost:8000/metrics || exit 1

        # Check frontend health
        curl -f http://localhost:3000/health || exit 1

    - name: Upload cluster logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: k8s-logs
        path: |
          /tmp/kind-logs/
